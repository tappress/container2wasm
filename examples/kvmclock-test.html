<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>QEMU-wasm kvmclock test</title>
    <link rel="stylesheet" href="./xterm.css" />
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #0f0; margin: 20px; }
        #terminal { width: 100%; height: 80vh; }
        h3 { margin-bottom: 5px; }
        p { margin-top: 0; color: #888; }
    </style>
</head>
<body>
    <h3>QEMU-wasm with kvmclock (Alpine 3.20)</h3>
    <p>Look for "kvm-clock" in boot messages to verify kvmclock is working.</p>
    <div id="info" style="margin-bottom: 10px; padding: 8px; background: #222; border: 1px solid #444;">
        <span>Browser cores: <strong id="hw-cores">-</strong></span> |
        <span>VM cores: <strong id="vm-cores">-</strong></span> |
        <span>Workers: <strong id="workers">-</strong></span>
    </div>
    <div id="terminal"></div>
    <script src="./xterm.js"></script>
    <script src="./xterm-pty.js"></script>
    <script src="./load.js"></script>
    <script src="./arg-module.js"></script>
    <script type="module">
        import initEmscriptenModule from './out.js';

        const xterm = new Terminal();
        xterm.open(document.getElementById("terminal"));

        const { master, slave } = openpty();
        xterm.loadAddon(master);

        Module.pty = slave;
        Module['mainScriptUrlOrBlob'] = location.origin + "/out.js";

        // Display hardware info
        document.getElementById('hw-cores').textContent = navigator.hardwareConcurrency || '?';

        // Parse VM cores from QEMU args
        const args = Module['arguments'] || [];
        const smpIdx = args.indexOf('-smp');
        let vmCores = 1;
        if (smpIdx !== -1 && args[smpIdx + 1]) {
            const smpArg = args[smpIdx + 1];
            const match = smpArg.match(/^(\d+)/);
            if (match) vmCores = parseInt(match[1]);
        }
        document.getElementById('vm-cores').textContent = vmCores;

        // Track workers (base pool + vCPU threads)
        let workerCount = 0;
        const origWorker = window.Worker;
        window.Worker = function(...args) {
            workerCount++;
            document.getElementById('workers').textContent = workerCount;
            return new origWorker(...args);
        };
        window.Worker.prototype = origWorker.prototype;

        let info = "t:" + Math.round(new Date() / 1000) + "\n";

        Module['preRun'].push((mod) => {
            mod.FS.mkdir('/pack');
            mod.FS.writeFile('/pack/info', info);
        });

        (async () => {
            const instance = await initEmscriptenModule(Module);

            var oldPoll = Module['TTY'].stream_ops.poll;
            var pty = Module['pty'];
            Module['TTY'].stream_ops.poll = function(stream, timeout){
                if (!pty.readable) {
                    return (pty.readable ? 1 : 0) | (pty.writable ? 4 : 0);
                }
                return oldPoll.call(stream, timeout);
            }
        })();
    </script>
</body>
</html>
